# 晶圆探针台测试系统(3)

- VISA和SCPI在测试和测量领域中扮演着核心角色，它们共同使得仪器的通信和控制变得更加标准化和高效。

##  1. VISA（Virtual Instrument Software Architecture）

- VISA是一个独立于平台和通信协议的软件接口标准，由美国国家仪器公司（National Instruments，NI）发起并维护。VISA的主要目的是提供一个统一的编程接口，使得开发者可以无需关心底层硬件和通信协议的细节，就能与各种测试和测量设备进行通信。

![VISA 架构](image-11.png)

- VISA的主要特点包括：

    - 跨平台支持
        ：VISA可以在多种操作系统上运行，如Windows、Linux和macOS。
    - 跨通信协议
        ：VISA支持多种通信协议，包括GPIB、Serial Port、USB、Ethernet等。
    - 资源管理
        ：VISA提供了资源管理功能，可以自动检测和配置仪器资源。

    - 高级功能
        ：VISA提供了一系列高级功能，如并行通信、消息触发、远程控制等。

    VISA通过提供一组标准的函数库，使得开发者可以轻松地在不同的编程语言中实现仪器的控制和数据采集。

    VISA库作为一套软件开发工具包（SDK），提供了一组丰富的函数，用于实现对各种测试和测量仪器的通信和控制。这些函数以动态链接库（DLL）或静态库（Lib）的形式提供，使得开发者可以在不同的编程环境中集成VISA功能。


## 案例: 用C#实现和示波器的通信

- 安装NI-VISA： 确保计算机上安装了NI-VISA库。这是使用VISA函数的基础，可以从National Instruments的官方网站下载并安装。

- 添加VISA库引用： 在C#项目中，您需要添加对VISA库的引用。通常，需要引用以下DLL：

- 这些DLL文件通常位于以下路径之一：

    - 在Visual Studio中，可以通过右键点击项目 -> 添加 -> 引用...，然后浏览到上述路径添加相应的DLL。

            C:\Program Files (x86)\National Instruments\VISA\WinNT\bin\
            C:\Windows\assembly\GAC_MSIL\NationalInstruments.Visa\
            NationalInstruments.Visa.dll
            Ivi.Visa.dll
- 使用VISA命名空间： 在C#代码文件顶部，使用以下命名空间：

``` CSharp
using NationalInstruments.Visa;
``` 

- 创建VISA会话： 创建一个VISA会话来与示波器通信。以下是一个示例代码，展示了如何创建一个会话并与GPIB接口的示波器通信：

``` CSharp
    // 创建VISA会话
    ViStatus status;
    ViSession rmSession, instrSession;
    status = VisaCHandle.CreateInstance("",out rmSession);
    if(status < ViStatus.Success)thrownewVisaException(status);

    // 打开与示波器的会话
    status = ViSession.Open(rmSession,"GPIB0::5::INSTR", ViAccessMode.NoLock, ViTimeout.Infinite,out instrSession);
    if(status < ViStatus.Success)thrownewVisaException(status);
    发送SCPI命令： 使用VISA会话发送SCPI命令到示波器，并接收响应。以下是一个发送“*IDN?”命令的示例：

    // 发送SCPI命令查询示波器标识
    string idn ="*IDN?";
    status = ViSession.WriteString(instrSession, idn.Length, idn);
    if(status < ViStatus.Success)thrownewVisaException(status);

    constint bufferSize =256;
    string response =newstring(newchar[bufferSize]);
    status = ViSession.ReadString(instrSession, bufferSize, response);
    if(status < ViStatus.Success)thrownewVisaException(status);

    Console.WriteLine("示波器响应: "+ response);
    关闭VISA会话： 完成通信后，关闭与示波器的会话，并释放资源：

    // 关闭会话
    ViSession.Close(instrSession);
    VisaCHandle.DestroyInstance(rmSession);
```

- 请注意，上述代码中的"GPIB0::5::INSTR"是示波器的VISA地址，其中"GPIB0"是GPIB接口板的名称，"5"是示波器连接到GPIB接口板的地址。如果示波器使用其他接口（如USB或Ethernet），则需要使用相应的VISA地址格式。

- 以上步骤展示了如何在C#项目中引用和使用VISA库。确保开发环境配置正确，并且已经安装了必要的NI-VISA库版本。这样，就可以在C#中轻松地与各种测试和测量设备进行通信了。

## 2. SCPI（Standard Commands for Programmable Instruments） 

    SCPI是一种标准化的命令语言，用于控制和查询测试和测量设备的状态。SCPI命令基于ASCII编码，遵循IEEE 488.2标准，并且可以在多种通信协议上实现。SCPI的主要特点包括：

- 标准化：SCPI提供了一套标准化的命令集，使得不同厂商的设备可以通过统一的命令进行控制。
- 树状结构：SCPI命令采用树状结构，使得命令的组织和记忆更加直观。
- 功能区分：SCPI命令分为控制命令（用于改变设备状态）和查询命令（用于获取设备状态）。
- 参数化：SCPI命令可以包含参数，以实现更灵活的设备控制。
- SCPI使得开发者可以通过发送简单的文本命令来控制仪器，这些命令在不同的设备和厂商之间具有很高的一致性。

### 示例：OUTPut子系统

- SCPI命令采用树状结构，以下是OUTPut子系统的一部分示例：

``` OUTPut
OUTPut:
  SYNC {OFF|0|ON|1}
  SYNC:
    MODE {NORMal|CARRier}
    POLarity {NORMal|INVerted}
```

- 在这个例子中，OUTPut 是根级关键字，SYNC 是第二级关键字，而 MODE 和 POLarity 是第三级关键字。冒号(:)用于分隔不同级别的关键字。

- 例如设置或读取电源电流值

    [SOURce:]CURRent[:LEVel][:IMMediate][:AMPLitude] <NRf>

- 设置电流

    SOURce:CURRent:LEVel:IMMediate:AMPLitude 5.0

- 这条命令将电流设置为5.0安培。

- 查询电流

    SOURce:CURRent:LEVel:IMMediate:AMPLitude?

- 这条命令查询当前设置的电流值。

    这些例子展示了如何使用SCPI命令来控制和查询仪器的状态。在实际应用中，您需要根据具体的仪器和需求来构造和发送相应的SCPI命令。

## 3. VISA与SCPI的关系
- VISA和SCPI经常一起使用，但它们在测试和测量系统中扮演不同的角色：

    - VISA 提供了与仪器通信的底层接口和工具，而 SCPI 提供了用于控制仪器的标准化命令集。
    - VISA抽象了通信协议和硬件平台的差异，而SCPI抽象了仪器操作的差异。
    - 开发者可以使用VISA库函数来发送SCPI命令，从而控制仪器。

    总的来说，VISA和SCPI共同为测试和测量领域提供了一个强大而灵活的通信和控制框架，使得开发者可以更加专注于应用层的开发，而不是底层的通信细节。
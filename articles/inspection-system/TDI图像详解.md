# 使用Zaber平台与TDI成像将成像通量提升10倍


**作者：** Stefan Martin, Mechanical Engineering Team & Mike Fussell, Life Sciences Product Manager
**最后更新：** 2025年5月27日

---

## **目录**

* 引言
* TDI成像技术介绍
* TDI成像的吞吐量优势
* 搭建TDI扫描系统的三种方法
  * 无触发
  * 直接编码器输出
  * IO同步
* 详细指南：如何为TDI设置Zaber Nucleus显微镜
  * 步骤1. 相机连接
  * 步骤2. 触发率计算
  * 步骤3. Zaber平台触发配置
  * 步骤4. 相机触发设置
  * 步骤5. 成像设置
  * 步骤6. 运动控制设置
  * 步骤7. 自动化扫描与成像
* TDI在大型扫描系统中的应用
* 结论
* 故障排除与技巧
  * 抖动问题

---

## **引言**

在许多生命科学研究和工业生物学应用中，成像通量是关键的性能指标。更快地捕获更多数据可以极大地缩短实验周期，使筛选设施能够覆盖更多的化合物和细胞系，并为OEM设备制造商提供显著的竞争优势。使用sCMOS相机进行时间延迟积分成像，是成倍提高显微镜成像输出的一种方法。

在本文中，我们将探讨：

* TDI相对于最先进的面阵扫描相机的性能优势和优点，以及如何为您的应用最大化这些优势。
* 同步相机与运动控制的三种不同方法。
* 使用Zaber的Nucleus显微镜、高速线性电机平台和Dhyana 9KTDI相机搭建您自己的TDI成像系统，以提供卓越成像通量的详细分步说明。

## **TDI成像技术介绍**

TDI成像建立在线扫描成像的基本原理之上。与更常见、更熟悉的面阵相机（具有许多水平行，每次曝光捕获一个大的二维区域）不同，线扫描相机只有单行像素。当目标相对于相机每移动一个像素的距离时，就会触发这行像素来获取一个薄的图像切片。通过将这些切片拼接在一起形成二维图像。虽然它们一次只能捕获单行像素，但线扫描相机的触发频率可高达数百kHz。

TDI相机采用这种基本方法并增加了多行。相机仍然在目标每移动一个像素距离时被触发，导致每个切片在扫描过程中被每一行捕获一次。然后，这些对每个切片的重复曝光被求和，从而在相同的曝光时间下，产生的图像比传统线扫描相机亮得多。

TDI Summation of multiple short exposures of each line generates a well exposed image

**这种求和过程使TDI相机能够提供非常高的扫描速度。** 例如，如果需要5毫秒的总采集时间来捕获可处理的图像，那么单行相机的移动速度只能是每5毫秒1个像素。一个假设的有5条水平线的TDI相机，每1毫秒移动1个像素，每条线扫描5次，将产生相同的5毫秒总曝光时间，但扫描速度比单行相机快5倍。Tucsen Dhyana 9KTDI相机有256条水平线。

**使用TDI相机进行连续扫描带来了几个关键优势：**

* 以恒定速度成像可显著减少共振振动，从而提供清晰、锐利的图像，而无需等待这些振动衰减，也无需通过输入整形来减轻振动的额外复杂性。
* Zaber的加加速度控制功能确保平台加速到扫描速度时运动曲线平滑。这将加速度和减速度产生的冲击降至最低，冲击可能对敏感样品产生负面影响。
* 消除了平台的加速、减速和稳定时间，这些时间通常占扫描总时间的很大一部分。

## **TDI成像的吞吐量优势**

TDI成像的连续扫描运动可以产生比同类大画幅面阵科学相机快得多的扫描。这种性能提升的幅度很大程度上取决于所需的曝光时间和使用的物镜放大倍率。

与“停拍”策略相比，其面积速率的优势取决于以下因素（按重要性排序）：

* 最小曝光时间
* 光学放大倍率
* 平台加速、移动和稳定时间
* 平台移动的最大速度

TDI vs Stop-and-Shoot Performance Plot

图2中的绘图显示了决定TDI成像是否适合您应用的两个重要趋势：

1. **TDI成像相对于停拍成像的相对性能优势在5倍到20倍放大倍率之间最大。** 随着放大倍率的增加，停拍策略所需的离散移动次数增加，导致稳定时间在总扫描时间中所占比例变大，从而限制了最大吞吐量。更高的放大倍率也限制了TDI成像的最大扫描速度，因为放大样品意味着需要更多的TDI切片来覆盖样品区域。
2. **TDI成像相对于停拍成像的相对性能优势在更短的曝光时间下最大。** 在需要长曝光的低光照条件下，更快的做法是长时间曝光，然后快速移动到下一个成像点，而不是缓慢地扫描样品。

Comparison of TDI imaging vs stop-and-shoot imaging times

在5毫秒曝光和10倍放大倍率下（图3），对于许多常见的高内涵筛选应用，这种TDI相机可以节省约55%的时间。在1毫秒曝光下，节省的时间接近85%！

为了最大化TDI相机的优势，值得仔细考虑可接受的最短曝光时间是多少。例如，一个高内涵成像系统，特别是其图像将被人工分析或用于发表的系统，通常会受益于更长的曝光和更低的增益。这将产生更详细、更美观的图像，并具有更好的信噪比。然而，对于需要二元响应且图像分析将由软件自动执行的诊断或实验，短得多的曝光时间和更高的增益可能是可以接受的。图像可能不那么美观，信噪比可能更低，但它们仍然可处理且清晰明了。

## **搭建TDI扫描系统的三种方法**

使用TDI相机捕获准确、无失真的图像，需要相机每移动一个像素的距离就触发一次。触发太快会使图像拉伸，而触发太慢则会压缩图像。有三种方法可以实现所需的定时：

### **无触发**

TDI扫描系统最简单的实现方式是让平台以预定速度移动，并将相机设置为期望样品以该速度移动。在没有平台和相机之间直接连接的情况下，无法实时调整相机来补偿速度波动。在实践中，Zaber线性电机直驱平台出色的速度稳定性意味着无触发TDI实现可以非常有效。免费的Zaber Launcher软件包中的“位置-速度-时间”工具使可视化和设置适当的运动序列变得容易。

> **标题：** 三种同步方法：无触发， 直接编码器输出， IO同步

### **直接编码器输出**

对于需要最严格同步的应用，一些高性能TDI相机可以接受正交编码器直接输入。这使相机能够直接测量平台的位置，并在恰好每像素距离触发一行。正交输出在Zaber直驱平台（包括ADR、LDA和LDM）上可用，需配合具有可选T8N1功能集的外部X-MCC控制器。一些TDI相机可能仍需要插值来支持相机的完整行频。X-MCC控制器上的`encoder.2.out.interpolation`设置可以调整每模拟编码器全周期在插值模拟编码器输出上生成的正交计数数量。与相机板载缩放相结合，可以精细控制相机的触发率。

### **IO同步**

像Zaber的X-LDA、X-ADR和X-LDM这样的直驱线性电机平台可以通过平台上的数字输出线与TDI相机接口。通过在平台上设置基于距离的触发，XY平台可以以特定的间隔向相机发送脉冲。在典型实现中，需要基于相机的缩放来使相机以高于IO所能支持的频率运行。相机的行频可能超过500 kHz，而Zaber X系列设备的最大触发频率为8 kHz。Zaber Launcher中的触发用户界面使配置基于距离的触发变得直观。下文提供了使用IO触发设置TDI相机的深入指南。

## **详细指南：如何为TDI设置Zaber Nucleus显微镜**

在本文中，我们选择了Tucsen Dyhana 9KTDI制冷sCMOS相机，最大触发频率为510 kHz。Dyahana 9KTDI属于新型sCMOS TDI相机，能够在256次读取的总输出上，以极低的7 e-总读出噪声换来极高的行频。我们将其与配备Zaber X-ADR130B100B线性电机显微镜平台的Nucleus® MVR自动倒置荧光显微镜配对。Zaber线性电机平台使用1 nm分辨率的光学编码器，使其具有极其精确和可重复的定位及编码器触发能力，并实现出色的速度稳定性。

Dyahana 9KTDI sCMOS camera and Nucleus microscope

### **步骤1. 相机连接**

对于我们的测试，使用了以下硬件和软件：

**硬件：**

* Nucleus MVR电动倒置荧光显微镜
* Zaber X-ADR130显微镜平台
* Tucsen Dyhana 9KTDI sCMOS相机
* Zaber D12 IO 电缆（随X-ADR平台附送）
* Sparkfun BOB-12009 逻辑电平转换器
* DfRobot DFR0140 5V / 3.3V USB电源
* Tucsen HR10A-7P-4P 触发电缆
* KAYA Komodo II 图像采集卡
* Tucsen M72x1 F-mount适配环
* Zaber MTC90x-F F-mount相机管（可应要求提供）

**软件：**

* Zaber Launcher 平台配置和控制软件
* KAYA VisionPoint 图像采集卡控制与配置软件
* Tucsen Sample Pro 相机控制与配置软件

> **重要笔记1：** Dyahana 9KTDI相机的IO工作电压为3.3V逻辑电平，而Zaber的IO工作电压为5V。本示例中使用了BOB-12009，一个基础、廉价的逻辑电平转换器，为信号提供低延迟电压转换。**这不是工业级组件，不建议在生产系统或关键应用中使用。** 为避免损坏相机，在打开电源之前，应特别注意将5V和3.3V引脚连接到正确的引脚。

> **重要笔记2：** 相机使用4根CoaXPress 2.0电缆连接到安装在主机PC PCI-E 8x插槽中的Komodo II图像采集卡。该相机**不使用**CXP供电功能，因此图像采集卡不需要额外的电源连接器。将相机连接到图像采集卡并将电源插头插入相机后，等待相机上的指示灯变绿，表示与图像采集卡的连接已建立。

### **步骤2. 触发率计算**

同步相机触发与样品运动对于捕获清晰、无失真的图像至关重要。可以使用以下公式确定触发频率（以kHz为单位）：
**ƒ = `(V • M) / p`**
其中，`V` 是平台速度（mm/s），`M` 是系统有效放大倍率，`p` 是像素间距（μm）。

可以使用https://example.com/link-to-spreadsheet的可下载电子表格轻松完成此计算。该电子表格可以执行“正向”计算（根据您所需的曝光时间找到所需的扫描速度），或“反向”计算（根据目标扫描速度和曝光时间返回所需的照明器辐射通量设置值）。两种计算都将返回`trigger encoder dist`和`TriggerRescalerRate`的值，这是下一步触发配置所需的参数。

触发率计算器电子表格

### **步骤3. Zaber平台触发配置**

在Zaber X-ADR平台上使用`trigger when encoder dist x`命令（固件7.12及以上版本），一旦编码器测量到平台至少移动了`x`个单位，就会触发IO。距离以微步为单位指定，如步骤2中计算。

> **注意：** 由于Zaber平台在10 kHz的时基上处理触发，计算器将触发频率限制在8 kHz，以提供最大的速度信息量，同时不遗漏任何触发。

```bash
# 基本IO触发设置
trigger 1 when 1 encoder dist x  # 每移动 x 微步触发一次
trigger 1 action a io set do 1 t # 触发时将 DO1 设置为脉冲
trigger 1 enable                 # 启用该触发
```

为了实现最有效的扫描时间，将使用在扫描之间交替方向的“蛇形”模式。有必要在每条扫描线结束时更改相机TDI方向以匹配平台方向。这是通过“相机方向”IO引脚实现的。向前移动时，引脚应设置为低电平；反向移动时，应设置为高电平。长扫描路径之间的步进距离应提供足够的重叠以辅助图像拼接，但又不能太多而增加许多额外的扫描路径。5%是一个不错的起始值。

Snake Pattern Scanning

以下一组触发将根据平台速度的正负号来设置TDI方向：

```bash
# 基于速度正负的方向控制触发
trigger 2 when 1 vel >= 0      # 当速度>=0时触发
trigger 3 when 2 vel < 0       # 当速度<0时触发
trigger 2 action a io set do 2 1 # 正向：DO2 设为高电平 (通常含义)
trigger 3 action a io set do 2 0 # 反向：DO2 设为低电平
trigger 2 enable
trigger 3 enable
```

### **步骤4. 相机触发设置**

为了实现更高的扫描速度并最大化这种成像技术的潜力，有必要将触发频率提高到超过Zaber平台的10 kHz时基。Dhyana 9KTDI相机包含一个​**触发器缩放器**​，它将接收到的触发频率乘以用户设置的值。这可以使用Tucsen SamplePro或KAYA VisionPoint软件进行配置。本示例中使用的触发设置如下：

| 设置项                          | 说明                                                                                                    |
| --------------------------------- | --------------------------------------------------------------------------------------------------------- |
| **方向**                  | 根据平台方向设置                                                                                        |
| **硬件触发**              | 启用                                                                                                    |
| **触发器缩放器**          | 设置为步骤2计算出的值                                                                                   |
| **TriggerRescalerFilter** | 对接收到的频率进行n次采样平均以提供更稳定的输出速率。建议设置为16。只有当缩放后的抖动大于5%时才增加它。 |
| **Pixel Format**          | 9KTDI的最大行频：12位时为300 kHz，8位时为510 kHz。                                                      |

Tucsen SamplePro Trigger Configuration

要测试设置，请使用Zaber Launcher中的`cycle`命令来回移动您的平台。检查“输入触发速率”和“缩放后触发速率”是否与步骤2中计算的值匹配。这些值在平台加速和减速时会波动，因此只有在平台达到稳定速度且运动到中间段时，这些值才是有效的。

### **步骤5. 成像设置**

成像前，必须将相机对准扫描方向。为此，在“面阵扫描”模式下启动相机，并松开Zaber MTC9X F-mount适配器上的锁紧环。将物镜对焦到样品上，然后旋转相机，使平台的扫描方向垂直于传感器。根据需要调整，然后拧紧锁环，将相机固定在正确位置。

图像采集卡附带的VisionPoint软件可以拼接TDI图像。在“图像采集卡扩展流功能 / 图像格式控制”部分，将`SegmentsPerBuffer`设置为一条扫描线的像素长度，将`Frames Per Stream`设置为蛇形模式中的扫描行数。

> **图10与图11描述：** 此部分在原文中为图像，内容分别是两张载玻片的全片扫描图，以及VisionPoint软件中“Image Format Control”的配置窗口截图，用于设置Segments Per Buffer。

> **图11 (无图) :** 展示 Vision Point 软件中的“Image Format Control”设置部分。

### **步骤6. 运动控制设置**

为了充分利用最新sCMOS TDI相机令人印象深刻的功能，您需要一个能够快速稳定运动和高精度编码器输出的运动控制解决方案。这里使用的Zaber X-ADR130 XY平台是TDI扫描的理想选择。主要优势是：

* **出色的速度稳定性。** X-ADR系列集成的控制器，加上其高推力的直线电机和低阻力的交叉滚子轴承，相对于丝杆驱动平台，提供了极其平滑的运动。
* **干涉仪校准的直接编码器。** 每个X-ADR平台都经过单独的干涉仪校准。这最大限度地减少了可能导致平台误读其速度的编码器栅距误差，并显著提高了速度分辨率和重复性。
* **高最大速度和加速度。** 峰值速度750 mm/s，加速度高达20 m/s²，X-ADR平台在亮场和透射成像方面表现出色，在这些应用中照明通常不是限制成像速度的因素。以全速和最大加速度，X-ADR平台可以在**不到2秒内**以2倍放大倍率扫描整个96孔板！
* **几乎无限的使用寿命。** X-ADR平台是高通量应用和集成到OEM设备中的理想选择。Zaber的线性电机平台已在24/7连续运行中测试超过1年，没有出现明显的磨损。
* **集成的控制器和驱动器。** 像所有Zaber X系列运动控制设备一样，X-ADR平台具有集成的控制器和驱动器，这意味着您的平台开箱即用。这极大地简化了系统设置。

为实现最佳性能，成像应在运动曲线的恒速部分进行，以避免由加速度和减速度引起的成像伪影。

为了获得尽可能好的扫描时间，应将X-ADR的上层轴用于长距离扫描运动。上层轴的移动质量较低，使其能够比必须承载上层轴质量的下层轴加速得更快。下层轴应执行长扫描路径之间的步进运动。在扫描速度>100mm/s时，应在样品范围之外包含一个超出行程余量，这样平台可以安全地加速、减速和改变方向，完全在样品区域之外。使用Zaber Launcher，将扫描轴的加速度和减速度设置得尽可能高，但不要失步。这最大限度地减少了在加速度和减速度阶段移动的距离。还建议在Zaber Launcher中将X-ADR扫描轴的伺服调谐设置为“刚性”，步进轴应调谐为“平滑”。这些设置将最大化速度稳定性，并防止扫描进行时出现不必要的振荡。

> **图13与图14描述：** 此部分是两张示意图，分别展示了扫描过程的运动控制阶段（加速、恒速扫描、减速、步进、方向改变、再加速等），以及平台速度、相机输入和扫描图像如何随时间变化的对应关系。

对于较高放大倍率下的大样本，需要协调垂直轴（Z轴）以补偿样品的平整度误差。在Zaber Nucleus显微镜上，这是通过向X-LDA对焦平台传递触发信号，以按顺序步进通过预加载的对焦点列表来实现的。

### **步骤7. 自动化扫描与成像**

为了最大化成像通量，可以使用Zaber的“流”功能将预设的运动序列直接加载并运行在平台的集成控制器上。这消除了通过外部计算机系统指挥平台运动所带来的通信延迟。关于使用流进行高速样品扫描的详细描述，请参阅本文：https://example.com/link-to-related-article 。

用于扫描96孔板的Python代码可以在https://example.com/link-to-code找到。此代码根据样品尺寸和XY轴的加速度，计算穿越样品的最快方式。基于这些值，它将生成一个流来执行运动序列。一旦此脚本生成的流被加载到控制器上，就可以通过调用存储的流来用于后续扫描。

配置相机和设置图像缓冲区是使用Kaya KYFG API实现的。它适用于Python和C#。这里的示例提供了使用Dhyana 9KTDI相机进行相机配置和图像采集的基本介绍。关于拼接和缓冲区管理的详细说明超出了本文的范围。

示例代码执行以下基本操作：

* 列出可用的图像采集卡
* 打开选定的图像采集卡
* 连接到相机0
* 使用键值对设置所需的相机设置
* 构造一个流缓冲区来容纳数据
* 分配一个回调函数来监视它
* 使用`KYFG_BufferAnnounce()`在`aligned_array`中分配内存以容纳帧缓冲区
* 启动相机，这将开始将数据转储到指定的缓冲区
* 通过ZML（Zaber Motion Language）开始扫描
* 在每一行扫描结束时：
  * 从内存中读取图像缓冲区
  * 将其附加到图像，同时考虑到每另一行会由于读取方向改变而被垂直翻转

> **图15与图16描述：** 此部分为TDI实际成像结果图，包括BPAE细胞和微流控液滴发生器的TDI扫描图像，并附有详细的成像参数。

> **图15 (无图)** ： BPAE细胞在385nm激发光下的TDI扫描图像。
> **图16 (无图)** ： 微流控液滴发生器的TDI扫描图像，扫描时间1.5秒。

## **TDI在大型扫描系统中的应用**

除了显微镜应用，TDI相机还可以与精密运动控制一起使用，用常规的机器视觉镜头以非常高的分辨率对样本成像。Zaber的龙门架系统是大型表面检测或画廊艺术品数字扫描等应用的理想平台。

Dhyana 9kTDI的45 mm线高也能使较小的样本在一次扫描中被捕获。这在扫描难以装载和卸载到样品架中的物体时特别有用，因为它允许样品架保持静止，而相机则扫描过样本。根据上述方法改编的一个示例，将9KTDI相机安装在Zaber X-LDM单轴线性电机平台上，以单次扫描捕获存档缩微胶片的高分辨率扫描图。

> **图17到图19描述：** 此部分展示带TDI相机的Zaber龙门架系统示意图、用于缩微胶片扫描的TDI相机安装示意图，以及用单次扫描完成缩微胶片扫描的最终图像。

> **图17 (无图)** ： 可用于大样品扫描的Zaber龙门架系统示例。
> **图18 (无图)** ： 用于缩微胶片扫描的TDI相机与X-LDM平台的安装实物图。
> **图19 (无图)** ： 450ms内完成缩微胶片扫描的最终图像。

## **结论**

**TDI成像可以带来比现有解决方案高一个数量级的成像速度提升！** 近年来相机图像传感器设计的发展催生了一类新型的低噪声sCMOS TDI相机，将TDI成像的速度优势带到了科学界。Zaber的线性电机X-ADR显微镜平台结合了极其快速和可重复的运动、精确的编码器和速度稳定性，使其成为TDI扫描系统的理想选择。将Zaber Nucleus倒置显微镜、X-ADR线性电机扫描平台和Dhyana 9KTDI相机相结合，创建了一个能够实现极高通量的模块化成像系统。

## **故障排除与技巧**

* **图像中有黑条** 表明您捕获的视野比显微镜能够成像的范围大。调整相机的`Width`和`Offset X`以消除此问题。
* ​**如果您的图像沿扫描轴看起来被压缩或拉伸**​，这表明触发频率不匹配。检查您的`trigger encoder dist`和`TriggerRescalerRate`。同时检查触发频率是否未设置得超过相机在您所选像素格式下所能运行的速度。
* ​**高灵敏度相机可能产生过亮的图像**​，即使在最低增益和最低照明器功率下也是如此。这可能在**使用低倍物镜进行亮场或透射照明成像时遇到！** 在光路中安装中性密度滤光片来修复此问题。
* ​**如果您的图像在扫描方向模糊，但在横向方向清晰**​，那么触发方向设置可能相反。
* ​**如果您看到带有模糊/波浪状外观的直线**​，这表明沿步进轴存在像素级偏移。尝试将伺服调谐改为“平滑”，这将使控制回路不那么激进。

### **抖动问题**

抖动是指运动曲线和成像触发相对于完美的恒定延迟和行间间距的方差。抖动问题会导致以下伪影：

* 触发频率不一致时的曝光差异
* 两次触发之间移动的距离超过一个完整像素时产生运动模糊

当平台减速停止时，您会看到随着触发周期变慢，亮度增加。输出图像中也会有明显的运动模糊。

抖动的总量可以使用相机上的`InputTriggerJitter`参数监控，以百分比为单位。以下是Zaber平台的一些代表性值，这些值产生了良好质量的图像：

| XY平台   | 速度 (mm/s) | InputTriggerJitter (%) |
| ---------- | ------------- | ------------------------ |
| X-ASR120 | 50          | 1.5                    |
| X-ADR130 | 100         | 1.0                    |

如果您在设置中遇到问题，请考虑以下一些抖动来源：

| 时序抖动                | 运动抖动                                         |
| ------------------------- | -------------------------------------------------- |
| 编码器量化              | 编码器标尺栅距误差                               |
| 固件处理方差 (\~1µs)   | 轴承阻力方差                                     |
| 电信号上升/下降时间方差 | 由于PID调谐导致的速度跟随误差波动                |
| 缩放器启动/停止         | 丝杆驱动平台可能存在螺距误差、背隙和螺母粘滑现象 |


# mDNS æ€ä¹ˆéƒ¨ç½²ï¼Œå¦‚ä½•å’ŒC#ä»£ç è¿›è¡Œç»“åˆä½¿ç”¨

ä¸‹é¢ç»™ä½ ä¸€ä»½ **å¯ç›´æ¥è½åœ°çš„ mDNSï¼ˆMulticast DNSï¼‰éƒ¨ç½²æ–¹æ¡ˆ + C# é›†æˆæ–¹å¼**ï¼Œç”¨äºåœ¨å±€åŸŸç½‘å†…å¿«é€Ÿå‘ç°é›†ç¾¤èŠ‚ç‚¹ã€é¿å…è·¯ç”±å™¨é‡å¯å¯¼è‡´ IP å˜æ›´çš„é—®é¢˜ã€‚

---

# âœ… 1. ä¸ºä»€ä¹ˆé›†ç¾¤éœ€è¦ mDNS

å½“è·¯ç”±å™¨é‡å¯åï¼ŒèŠ‚ç‚¹ï¼ˆServerã€Agentã€Sensorã€H3000 ä¸»æœºç­‰ï¼‰ä¼šé‡æ–°è·å– DHCP IPï¼ŒIP å˜äº†å¯¼è‡´å®¢æˆ·ç«¯æ‰¾ä¸åˆ°èŠ‚ç‚¹æœåŠ¡ã€‚

**mDNS èƒ½å¤Ÿè§£å†³ï¼š**

* å±€åŸŸç½‘è‡ªåŠ¨å‘ç°è®¾å¤‡
* ä½¿ç”¨å›ºå®šåå­—ï¼ˆhostname.localï¼‰ä»£æ›¿åŠ¨æ€ IP
* ä¸éœ€è¦éƒ¨ç½²ä¸­å¿ƒåŒ– DNS
* é›¶é…ç½®ï¼ˆZeroConfï¼‰

ä¾‹å¦‚ä½ çš„èŠ‚ç‚¹å¯ä»¥æš´éœ²ï¼š

```
h3000-node1.local â†’ 192.168.1.45
h3000-node2.local â†’ 192.168.1.102
```

C# ç¨‹åºè‡ªåŠ¨å‘ç°å³å¯ã€‚

---

# âœ… 2. mDNS å¦‚ä½•éƒ¨ç½²ï¼ˆå„å¹³å°ï¼‰

## **â‘  Linuxï¼ˆUbuntu / Debianï¼‰**

æœ€æ ‡å‡†æ–¹å¼ï¼šä½¿ç”¨ Avahiï¼ˆå¼€æº mDNS responderï¼‰

### **å®‰è£…**

```bash
sudo apt install avahi-daemon avahi-utils
sudo systemctl enable avahi-daemon
sudo systemctl start avahi-daemon
```

### **å‘å¸ƒä¸€ä¸ªæœåŠ¡ï¼ˆå¦‚ä½ èŠ‚ç‚¹çš„ gRPC æœåŠ¡ 50051ï¼‰**

åˆ›å»ºæ–‡ä»¶ï¼š

```
/etc/avahi/services/h3000-node.service
```

å†…å®¹ï¼š

```xml
<service-group>
  <name replace-wildcards="yes">H3000 Node %h</name>
  <service>
    <type>_grpc._tcp</type>
    <port>50051</port>
  </service>
</service-group>
```

é‡å¯ï¼š

```bash
sudo systemctl restart avahi-daemon
```

---

## **â‘¡ Windows**

Windows åŸç”Ÿä¸å†…ç½® mDNSï¼Œä½†å¯ä»¥è£… **Bonjour**ï¼ˆè‹¹æœçš„ mDNSResponderï¼‰ï¼š

### **å®‰è£… Bonjour**

âœ” æœ€ç¨³å®šæ–¹æ¡ˆï¼šå®‰è£… iTunes / Bonjour Print Services
å®˜æ–¹ Bonjour MSIï¼š

```
Bonjour64.msi
```

å®‰è£…åä¼šæœ‰ï¼š

```
mDNSResponder.exe
```

Windows èŠ‚ç‚¹å³å¯è¢« mDNS è§£æã€‚

---

## **â‘¢ åµŒå…¥å¼è®¾å¤‡ / Docker**

Docker Container ä¸­ä½¿ç”¨ mDNSï¼š

```bash
apt install avahi-daemon
```

å¹¶æ·»åŠ ï¼š

```
"--net=host"
```

å¦åˆ™ mDNS multicast æ— æ³•æ­£å¸¸æµé€šã€‚

---

# âœ… 3. å¦‚ä½•åœ¨ C# ä¸­ä½¿ç”¨ mDNSï¼ˆæœåŠ¡å‘ç°ï¼‰

### **æ¨èåº“ï¼šMakaretu.MDNS**

NuGetï¼š

```
Install-Package Makaretu.MDNS
```

---

## **ğŸ“Œ (A) å‘ç°å±€åŸŸç½‘å†…æ‰€æœ‰èŠ‚ç‚¹ï¼ˆç›‘å¬æœåŠ¡ï¼‰**

```csharp
using Makaretu.MDNS;

var serviceDiscovery = new ServiceDiscovery();
serviceDiscovery.ServiceInstanceDiscovered += (s, e) =>
{
    Console.WriteLine($"å‘ç°æœåŠ¡: {e.ServiceInstanceName}");
};

serviceDiscovery.QueryAllServices();

// é˜»å¡
await Task.Delay(-1);
```

ç»“æœç¤ºä¾‹ï¼š

```
å‘ç°æœåŠ¡: H3000 Node MyHostName._grpc._tcp.local
```

---

## **ğŸ“Œ (B) æŸ¥è¯¢æŒ‡å®šæœåŠ¡**

```csharp
var sd = new ServiceDiscovery();

sd.ServiceInstancesChanged += (s, e) =>
{
    foreach (var service in e.ServiceInstances)
    {
        Console.WriteLine("å‘ç°èŠ‚ç‚¹:");
        Console.WriteLine($"Name: {service.Name}");
        Console.WriteLine($"Host: {service.HostName}");
        Console.WriteLine($"IP:   {string.Join(",", service.Addresses)}");
        Console.WriteLine($"Port: {service.Port}");
    }
};

sd.Subscribe("_grpc._tcp");
await Task.Delay(-1);
```

ä½ ä¼šè·å–ï¼š

```
H3000 Node host-01.local
192.168.1.45:50051
```

---

# âœ… 4. C# ä½œä¸ºèŠ‚ç‚¹å‘å¸ƒ mDNS æœåŠ¡ï¼ˆè‡ªå¸¦å¹¿æ’­ï¼‰

```csharp
using Makaretu.MDNS;

var sd = new ServiceDiscovery();
var service = new ServiceProfile(
    "H3000 Node",   // æœåŠ¡åç§°
    "_grpc._tcp",   // ç±»å‹
    50051           // ç«¯å£
);

sd.Advertise(service);
Console.WriteLine("mDNS æœåŠ¡å·²å‘å¸ƒ");
await Task.Delay(-1);
```

æ•ˆæœï¼šç½‘ç»œä¸­ä¼šå‡ºç°å¯å‘ç°èŠ‚ç‚¹ã€‚

---

# âœ… 5. é›†ç¾¤åœºæ™¯æœ€ä½³å®è·µ

| åŠŸèƒ½        | å®ç°æ–¹å¼                               |
| --------- | ---------------------------------- |
| å‘ç°åœ¨çº¿èŠ‚ç‚¹    | C# QueryAllServices()              |
| èŠ‚ç‚¹è‡ªåŠ¨ä¸Šçº¿é€šçŸ¥  | ServiceInstanceDiscovered äº‹ä»¶       |
| èŠ‚ç‚¹æ‰çº¿æ£€æµ‹    | ServiceInstanceShutdown äº‹ä»¶         |
| é¿å… IP å˜æ›´  | ä½¿ç”¨ hostname.local æˆ–æœåŠ¡å             |
| æ¯èŠ‚ç‚¹æš´éœ²å¤šä¸ªæ¨¡å— | mDNS å¤šServiceï¼š_grpcï¼Œ_restï¼Œ_metrics |

---

# ğŸ”¥ 6. æ¨èä½ çš„ H3000 èŠ‚ç‚¹å‘½åè§„èŒƒï¼ˆå¯ç›´æ¥ç”¨ï¼‰

| èŠ‚ç‚¹ç±»å‹  | mDNS åç§°                 | æœåŠ¡å            |
| ----- | ----------------------- | -------------- |
| é‡‡é›†æœåŠ¡å™¨ | `h3000-collector.local` | `_grpc._tcp`   |
| ç®—æ³•èŠ‚ç‚¹  | `h3000-algo1.local`     | `_algo._tcp`   |
| å­˜å‚¨èŠ‚ç‚¹  | `h3000-storage.local`   | `_nfs._tcp`    |
| ä¸»æ§    | `h3000-master.local`    | `_master._tcp` |

è¿™æ ·è·¯ç”±å™¨é‡å¯åå…¨éƒ¨æœåŠ¡å¯è¢«è‡ªåŠ¨æ‰¾åˆ°ã€‚

---

# å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ æä¾›ï¼š

âœ… ç»™ä½  **å®Œæ•´çš„ C# æœåŠ¡å‘ç°æ¨¡æ¿å·¥ç¨‹ï¼ˆ.slnï¼‰**
âœ… ç»™ä½  **Docker ç‰ˆæœ¬ mDNS é…ç½®æ–‡ä»¶**
âœ… ç»™ä½  **Linux + Avahi æ‰¹é‡æ³¨å†ŒèŠ‚ç‚¹è„šæœ¬**
ä½ è¦å“ªç§ï¼Ÿ

# 消息模板（Message Templates）

[最佳实践入口](https://github.com/NLog/NLog/wiki/How-to-use-structured-logging#transform-captured-properties)

- 消息日志模板起到语言中立规范，旨在为结构化日志记录提供一种既对人类友好，又对机器可读的格式。以下是其主要内容的详细总结：

![message-viewer](message-viewer.png)
## 一、背景与动机
传统日志的局限性：
早期文本日志（ printf  调试）：生成纯文本流，在简单、单机应用中有效，但在复杂、分布式系统中，需要通过正则表达式解析来提取信息，处理非平凡诊断场景时费力且低效。
纯结构化日志（键值对）：将事件记录为键值对（如 JSON），机器可读性极佳（支持属性查询），但对人类不友好，长串键值对难以视觉处理和快速理解。
基于约定的混合格式：在  printf  风格消息中嵌入  key=value  约定（如  username=%s ）。理论上可读性更好，但格式松散，存在解析歧义（如属性值包含空格或  = ），且缺乏明确的语法和验证，导致团队使用不一致。
带清单的系统（如 ETW）：结合事件 ID 和格式说明符清单，在性能、人机可读性间取得平衡，但需要管理事件 ID 和清单，开发体验较差，限制了普及。
核心需求：需要一个方案，能同时优化人类友好性、机器可读性和开发体验，以支持现代复杂分布式应用。

## 二、消息模板概述
消息模板综合了上述方法的优点，提出了一个统一的解决方案。
定义：一种包含命名占位符（“洞”） 的格式说明符，例如： User {username} logged in from   {ip_address} 。
双重作用：它不仅是渲染事件为人类可读文本的模板，也是捕获结构化事件数据的手段。
工作流程： 
捕获：日志 API 通过位置匹配将参数值填入模板的占位符，生成一个包含原始模板和所有属性值的中间结构化表示（如 JSON 对象），而非立即渲染为文本。
优势：由于模板本身作为常量被捕获，它可以作为事件类型标识符，便于对来自同一模板的所有事件进行分组、查询和分析。
渲染：当需要向人类用户显示或进行文本搜索时，再将属性值代入模板，生成友好的文本消息。

## 三、语法规范
消息模板的语法由以下规则定义（通过铁路图描述）：
模板（Template）：由文本（Text） 和占位符（Hole） 交替组成的序列。
<!-- 文本（Text）：普通字符序列。花括号  {  和  }  可以通过双写转义（ {{  转义为  { ， }}  转义为  } ）。 -->
<!-- 占位符（Hole）：格式为  { [@|$] (Name|Index) [, Alignme  nt] [: Format] } 。  -->
属性名（Name）：由字母、数字和下划线组成。或使用数字索引（Index）。
操作符（Operator）：可选前缀。 
 @ ：结构化捕获操作符，提示应保留参数的结构（例如通过序列化）。
 $ ：字符串化操作符，提示应将参数转换为字符串形式进行捕获。
无操作符：捕获行为由实现决定。
对齐（Alignment）：可选，格式为  , -?[0-9]+ ，用于控制渲染时的字段宽度和对齐方式。
格式（Format）：可选，格式为  : [^}]+ ，用于控制属性的渲染样式（如日期格式、数字格式）。语义是应用相关的，因此如果渲染可能在不同环境中进行，需要同时捕获原始值和格式化后的值。

## 四、捕获规则
参数匹配： 
如果模板全部使用数字属性名（如  {0} ,  {1} ），则按数字索引捕获参数。
如果模板中有任何非数字属性名，则所有参数按占位符在模板中从左到右出现的顺序进行匹配。
不允许重复的属性名。对于无效或重复名称的处理行为由具体实现决定。

## 五、渲染语义
核心任务：给定一组属性值和一个消息模板，实现应通过将属性值替换到对应占位符的位置来渲染模板。
优化原则：渲染应为可读性、以及目标环境的惯例、文化和上下文进行优化。
处理异常： 
对于没有对应属性值的占位符，可以渲染为原始的  {...}  标记，也可以替换为空白/空值/哨兵值。
数字、日期、时间等可以按特定文化格式渲染。
复杂数据可以以用户最熟悉的格式呈现。

## 六、实现与生态
文档列举了支持消息模板的多种编程语言的日志库，表明该规范已被广泛采纳。示例包括：
    C#: Serilog, NLog, Microsoft.Extensions.Logging 等。
    F#: FsMessageTemplates, Logary。
    Go: mtlog, structlog。
    Java: serilogj。
    JavaScript/TypeScript: serilogger, structured-log。
    PHP: arnapou/message-templates。
    Python: Seqlog。
    Ruby: Semlogr。
    Rust: Emit（将自定义捕获语法转换为消息模板）。
以及其他（C++, Kotlin 等）。 文档鼓励社区反馈以补充列表。
核心价值总结
消息模板规范通过一个定义明确、可解析的语法，统一了日志事件的捕获和渲染过程：
对人类友好：渲染后的文本消息自然、易读。
对机器完美可读：捕获的结构化数据（模板+属性）支持高效的查询、过滤和分析。
开发体验佳：语法直观，易于编写和验证，避免了传统混合格式的歧义和不一致问题。
语言中立与互操作性：作为规范，促进了不同语言和日志库之间的一致性和数据交换能力。